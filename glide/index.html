<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Glide - See your route before you go. Glide smoothly.</title>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="glide-icon.svg">

  <!-- iOS Home Screen -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Glide">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141416;
      --bg-tertiary: #1c1c1f;
      --bg-elevated: #242428;
      --text-primary: #fafafa;
      --text-secondary: #a1a1a6;
      --text-muted: #636366;
      --accent: #22c55e;
      --accent-dim: #16a34a;
      --accent-glow: rgba(34, 197, 94, 0.15);
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #2c2c30;
      --radius: 12px;
      --radius-sm: 8px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    .app-container {
      display: grid;
      grid-template-columns: 1fr 380px;
      grid-template-rows: auto 1fr;
      height: 100vh;
      gap: 1px;
      background: var(--border);
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: var(--bg-secondary);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
    }

    .logo-icon svg {
      width: 100%;
      height: 100%;
      color: var(--bg-primary);
    }
      width: 20px;
      height: 20px;
      color: var(--bg-primary);
    }

    .logo-text {
      font-weight: 600;
      font-size: 18px;
      letter-spacing: -0.02em;
    }

    .logo-strapline {
      font-size: 12px;
      color: var(--text-muted);
      border-left: 1px solid var(--border);
      padding-left: 12px;
      margin-left: 4px;
    }

    .logo-badge {
      font-size: 11px;
      font-weight: 500;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      padding: 4px 8px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .steps-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--bg-elevated);
      transition: all 0.2s ease;
    }

    .step-dot.active {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .step-dot.completed {
      background: var(--accent);
    }

    .step-line {
      width: 24px;
      height: 2px;
      background: var(--bg-elevated);
    }

    .step-line.completed {
      background: var(--accent);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .theme-toggle {
      width: 40px;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .theme-toggle:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
    }

    /* Light mode */
    body.light-mode {
      --bg-primary: #f5f5f7;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e8e8ed;
      --bg-elevated: #ffffff;
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --text-muted: #98989d;
      --border: #d2d2d7;
      --accent-glow: rgba(34, 197, 94, 0.2);
    }

    body.light-mode .streetview-image-container {
      background: #e8e8ed;
    }

    body.light-mode .map-container {
      background: #e8e8ed;
    }

    /* Main content */
    .main-content {
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .view-area {
      flex: 1 1 0;
      min-height: 0;
      position: relative;
      overflow: hidden;
    }

    .map-container {
      position: absolute;
      inset: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Elevation profile */
    .elevation-profile {
      background: var(--bg-elevated);
      border-top: 1px solid var(--border);
      padding: 8px 16px 6px;
      display: none;
      flex-shrink: 0;
      position: relative;
      z-index: 20;
    }

    .elevation-profile.active {
      display: block;
    }

    /* Elevation profile stays visible during street view */

    .elevation-canvas-container {
      position: relative;
    }

    .elevation-marker {
      position: absolute;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border: 2px solid var(--bg-elevated);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 8px var(--accent);
      display: none;
      pointer-events: none;
      z-index: 5;
    }

    .elevation-marker.active {
      display: block;
    }

    .elevation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .elevation-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    .elevation-stats {
      color: var(--text-muted);
    }

    #elevation-canvas {
      width: 100%;
      height: 80px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .elevation-legend {
      display: flex;
      gap: 16px;
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .legend-color {
      width: 12px;
      height: 8px;
      border-radius: 2px;
    }

    .legend-color.safe { background: #22c55e; }
    .legend-color.moderate { background: #f59e0b; }
    .legend-color.steep { background: #ef4444; }

    /* Street view panel */
    .streetview-panel {
      position: absolute;
      inset: 0;
      background: var(--bg-secondary);
      display: none;
      flex-direction: column;
    }

    .streetview-panel.active {
      display: flex;
    }

    .streetview-panel.show-map {
      background: transparent;
    }

    .streetview-panel.show-map .playback-controls {
      display: none;
    }

    .streetview-panel.show-map .streetview-image-container {
      opacity: 0;
      pointer-events: none;
    }

    .streetview-image-container {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #000;
    }

    .streetview-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .streetview-image.active {
      opacity: 1;
      z-index: 2;
    }

    .streetview-image.previous {
      opacity: 0;
      z-index: 1;
    }

    .streetview-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      color: var(--text-muted);
    }

    .streetview-placeholder svg {
      width: 64px;
      height: 64px;
      opacity: 0.3;
    }

    .mini-map-container {
      position: absolute;
      bottom: 16px;
      right: 16px;
      width: 200px;
      height: 150px;
      border-radius: var(--radius);
      overflow: hidden;
      border: 2px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 10;
    }

    #mini-map {
      width: 100%;
      height: 100%;
    }

    .streetview-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 230px;
      padding: 20px 24px;
      background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
      pointer-events: none;
      z-index: 10;
    }

    .overlay-stats {
      display: flex;
      gap: 24px;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .stat-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      font-weight: 500;
    }

    .stat-value.warning { color: var(--warning); }
    .stat-value.good { color: var(--accent); }

    .frame-counter {
      position: absolute;
      top: 16px;
      right: 70px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .view-toggle-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 20;
      width: 44px;
      height: 44px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      border: none;
      border-radius: var(--radius-sm);
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .view-toggle-btn:hover {
      background: rgba(0,0,0,0.8);
    }

    .view-toggle-btn svg {
      width: 22px;
      height: 22px;
    }

    .back-btn {
      position: absolute;
      top: 16px;
      left: 16px;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s ease;
    }

    .back-btn:hover { background: rgba(0,0,0,0.8); }
    .back-btn svg { width: 16px; height: 16px; }

    /* Playback controls */
    .playback-controls {
      background: var(--bg-secondary);
      padding: 16px 24px;
      border-top: 1px solid var(--border);
    }

    .progress-bar {
      display: none;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s linear;
    }

    .controls-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .transport-controls {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .speed-control {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .speed-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: center;
    }

    .control-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .control-btn:hover { background: var(--bg-tertiary); }

    .control-btn.play-btn {
      width: 44px;
      height: 44px;
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-primary);
    }

    .control-btn.play-btn:hover { background: var(--accent-dim); }
    .control-btn svg { width: 16px; height: 16px; }

    /* Fullscreen button - hidden on desktop */
    .fullscreen-btn {
      display: none;
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-handle {
      display: none;
      justify-content: center;
      padding: 10px;
      cursor: grab;
      touch-action: none;
    }

    .handle-bar {
      width: 40px;
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--bg-tertiary);
    }

    .sidebar-section {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    /* Route inputs */
    .route-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-group {
      position: relative;
    }

    .input-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .input-icon.origin { background: var(--accent); }
    .input-icon.destination { background: var(--danger); }

    .route-input {
      width: 100%;
      padding: 12px 12px 12px 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      transition: all 0.15s ease;
    }

    .route-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .route-input::placeholder { color: var(--text-muted); }

    .route-input.has-location-btn {
      padding-right: 44px;
    }

    .location-btn {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }

    .location-btn:hover {
      color: var(--accent);
      background: var(--bg-tertiary);
    }

    .location-btn svg {
      width: 20px;
      height: 20px;
    }

    /* Travel mode selector */
    .mode-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      margin-top: 14px;
    }

    .mode-btn {
      padding: 10px 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease;
    }

    .mode-btn:hover { background: var(--bg-tertiary); }

    .mode-btn.active {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }

    .mode-btn svg { width: 20px; height: 20px; }

    /* Action buttons */
    .action-btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 14px;
      transition: all 0.15s ease;
    }

    .action-btn.primary {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .action-btn.primary:hover { background: var(--accent-dim); }

    .action-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .action-btn.secondary:hover { background: var(--bg-tertiary); }

    .action-btn:disabled {
      background: var(--bg-elevated);
      color: var(--text-muted);
      cursor: not-allowed;
    }

    /* Recent Routes */
    .recent-routes {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .recent-routes-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .recent-routes-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .recent-route-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .recent-route-item:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
    }

    .recent-route-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      flex-shrink: 0;
    }

    .recent-route-icon svg {
      width: 18px;
      height: 18px;
    }

    .recent-route-info {
      flex: 1;
      min-width: 0;
    }

    .recent-route-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .recent-route-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Route options */
    .route-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .route-option {
      padding: 14px;
      background: var(--bg-elevated);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .route-option:hover { background: var(--bg-tertiary); }

    .route-option.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
    }

    .route-option-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .route-option-name {
      font-weight: 600;
      font-size: 14px;
    }

    .route-option-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .route-option-badge.recommended {
      background: var(--accent-glow);
      color: var(--accent);
    }

    .route-option-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .route-option-summary {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      line-height: 1.4;
    }

    /* Route summary */
    .route-summary {
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      margin-top: 14px;
    }

    .route-summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .summary-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 16px;
      font-weight: 500;
    }

    /* Drag hint */
    .drag-hint {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      margin-top: 14px;
    }

    .accessibility-notice {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      padding: 12px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: var(--radius-sm);
      margin-top: 14px;
    }

    .accessibility-notice strong {
      color: var(--accent);
    }

    /* Status bar */
    .status-bar {
      padding: 12px 20px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .status-bar .version {
      margin-left: auto;
      opacity: 0.5;
      font-size: 10px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .status-dot.loading {
      background: var(--warning);
      animation: pulse 1s infinite;
    }

    .status-dot.ready { background: var(--accent); }
    .status-dot.error { background: var(--danger); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    /* Coverage */
    .coverage-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
    }

    .coverage-bar {
      flex: 1;
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .coverage-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    .coverage-text {
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(10, 10, 11, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      z-index: 1000;
    }

    .loading-overlay.visible { display: flex; }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--bg-elevated);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .loading-progress {
      width: 200px;
      height: 4px;
      background: var(--bg-elevated);
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.2s ease;
    }

    /* Google Maps styling overrides */
    .gm-style .gm-style-iw-c { display: none !important; }

    /* Password Gate */
    .password-gate {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .password-gate.hidden {
      display: none;
    }

    .password-modal {
      text-align: center;
      padding: 40px;
      max-width: 400px;
      width: 100%;
    }

    .password-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .password-logo-icon {
      width: 48px;
      height: 48px;
      background: var(--accent);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
    }

    .password-logo-icon svg {
      width: 100%;
      height: 100%;
      color: var(--bg-primary);
    }

    .password-logo-text {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .password-tagline {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 32px;
    }

    .password-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .password-input {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 16px;
      font-size: 16px;
      color: var(--text-primary);
      text-align: center;
      font-family: inherit;
    }

    .password-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .password-btn {
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 600;
      color: var(--bg-primary);
      cursor: pointer;
      font-family: inherit;
      transition: background 0.2s ease;
    }

    .password-btn:hover {
      background: var(--accent-dim);
    }

    .password-error {
      color: var(--danger);
      font-size: 13px;
      margin-top: 12px;
      min-height: 20px;
    }

    /* ==========================================
       RESPONSIVE STYLES
       ========================================== */

    /* Tablet breakpoint */
    @media (max-width: 900px) {
      .app-container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }

      .header {
        padding: 12px 16px;
      }

      .logo-strapline {
        font-size: 11px;
        padding-left: 10px;
        margin-left: 2px;
      }

      .steps-indicator {
        display: none;
      }

      .header-right {
        gap: 8px;
      }

      .theme-toggle {
        width: 36px;
        height: 36px;
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
      }

      .main-content {
        grid-row: 2;
      }

      .sidebar {
        grid-row: 3;
        max-height: 45vh;
        border-top: 1px solid var(--border);
      }

      .sidebar-content {
        padding-bottom: 20px;
      }

      .mini-map-container {
        width: 150px;
        height: 110px;
        bottom: 12px;
        right: 12px;
      }
    }

    /* Mobile breakpoint */
    @media (max-width: 600px) {
      .app-container {
        grid-template-rows: auto 1fr 40vh;
        height: 100dvh; /* Dynamic viewport height for mobile browsers */
      }

      .header {
        padding: 10px 12px;
        gap: 8px;
      }

      .logo {
        gap: 8px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        padding: 3px;
      }

      .logo-text {
        font-size: 16px;
      }

      .logo-strapline {
        font-size: 12px;
        padding-left: 8px;
        margin-left: 0;
        white-space: nowrap;
      }

      .sidebar {
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .sidebar.collapsed {
        max-height: 60px;
      }

      .sidebar.collapsed .sidebar-content {
        display: none;
      }

      .sidebar.collapsed .status-bar {
        border-top: none;
      }

      .sidebar-handle {
        display: flex;
      }

      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .sidebar-section {
        padding: 14px;
      }

      .section-title {
        font-size: 10px;
        margin-bottom: 12px;
      }

      /* Larger touch targets for inputs */
      .route-input {
        padding: 14px 14px 14px 34px;
        font-size: 16px; /* Prevents iOS zoom on focus */
      }

      /* Mode selector - single row on mobile */
      .mode-selector {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .mode-btn {
        padding: 8px 4px;
        min-height: auto;
        font-size: 10px;
      }

      .mode-btn svg {
        width: 20px;
        height: 20px;
      }

      /* Larger action buttons */
      .action-btn {
        padding: 16px;
        font-size: 15px;
        min-height: 50px;
      }

      /* Route options */
      .route-option {
        padding: 12px;
      }

      .route-option-name {
        font-size: 13px;
      }

      .route-option-stats {
        font-size: 12px;
      }

      .route-summary {
        padding: 12px;
      }

      .summary-value {
        font-size: 14px;
      }

      .drag-hint,
      .accessibility-notice {
        font-size: 11px;
        padding: 10px;
      }

      /* Status bar */
      .status-bar {
        padding: 10px;
        font-size: 11px;
      }

      /* Elevation profile - smaller on mobile */
      .elevation-profile {
        padding: 6px 12px 4px;
      }

      #elevation-canvas {
        height: 50px;
      }

      .elevation-header {
        font-size: 11px;
        margin-bottom: 3px;
      }

      .elevation-legend {
        gap: 10px;
        font-size: 10px;
        margin-top: 2px;
      }

      /* Street view panel - display in map area on mobile (like desktop) */
      .streetview-panel {
        position: absolute;
        inset: 0;
        z-index: 10;
      }

      /* Fullscreen mode for Street View on mobile */
      body.streetview-fullscreen .streetview-panel {
        position: fixed;
        inset: 0;
        z-index: 100;
      }

      body.streetview-fullscreen .sidebar {
        display: none;
      }

      body.streetview-fullscreen .header {
        display: none;
      }

      body.streetview-fullscreen .app-container {
        grid-template-rows: 1fr;
      }

      .back-btn {
        padding: 12px 14px;
        font-size: 12px;
        top: 12px;
        left: 12px;
      }

      .frame-counter {
        padding: 6px 10px;
        font-size: 11px;
        top: 12px;
        right: 60px;
      }

      .view-toggle-btn {
        top: 12px;
        right: 12px;
        width: 40px;
        height: 40px;
      }

      .view-toggle-btn svg {
        width: 20px;
        height: 20px;
      }

      /* Mini map smaller on mobile */
      .mini-map-container {
        width: 120px;
        height: 90px;
        bottom: 10px;
        right: 10px;
        border-radius: var(--radius-sm);
      }

      /* Stats overlay */
      .streetview-overlay {
        right: 140px;
        padding: 12px 16px;
      }

      .stat-label {
        font-size: 9px;
      }

      .stat-value {
        font-size: 12px;
      }

      /* Playback controls */
      .playback-controls {
        padding: 12px 16px;
      }

      .progress-bar {
        height: 8px;
        margin-bottom: 12px;
      }

      .transport-controls {
        gap: 8px;
      }

      /* Hide skip-to-end on mobile - keep skip-to-start for restarting */
      .skip-btn {
        display: none;
      }

      .control-btn {
        width: 44px;
        height: 44px;
        border-radius: var(--radius);
      }

      /* Play button same size for consistent row */
      .control-btn.play-btn {
        width: 44px;
        height: 44px;
      }

      .control-btn svg {
        width: 18px;
        height: 18px;
      }

      /* Controls layout: nav (left) | speed (center) | fullscreen (right) */
      .controls-row {
        justify-content: space-between;
        gap: 12px;
      }

      .transport-controls {
        gap: 6px;
      }

      .speed-control {
        gap: 6px;
      }

      .speed-value {
        font-size: 12px;
        min-width: 42px;
      }

      /* Show fullscreen button on mobile */
      .fullscreen-btn {
        display: flex;
      }

      /* Loading overlay */
      .loading-text {
        font-size: 13px;
      }

      .loading-progress {
        width: 160px;
      }
    }

    /* Very small screens */
    @media (max-width: 380px) {
      .header {
        padding: 8px 10px;
      }

      .logo-text {
        font-size: 14px;
      }

      .logo-strapline {
        display: none;
      }

      .sidebar-section {
        padding: 12px;
      }

      .mode-btn {
        padding: 10px 6px;
        font-size: 11px;
      }

      .mode-btn svg {
        width: 20px;
        height: 20px;
      }

      .mini-map-container {
        width: 100px;
        height: 75px;
      }

      .streetview-overlay {
        right: 110px;
        padding: 10px 12px;
      }

      .overlay-stats {
        gap: 16px;
      }

      .control-btn {
        width: 40px;
        height: 40px;
      }

      .control-btn.play-btn {
        width: 48px;
        height: 48px;
      }
    }

    /* Landscape mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      .app-container {
        grid-template-columns: 1fr 280px;
        grid-template-rows: auto 1fr;
      }

      .header {
        padding: 8px 12px;
      }

      .logo-icon {
        width: 28px;
        height: 28px;
      }

      .logo-text {
        font-size: 14px;
      }

      .sidebar {
        max-height: none;
        grid-row: 2;
      }

      .sidebar-section {
        padding: 10px 12px;
      }

      .mode-selector {
        grid-template-columns: repeat(4, 1fr);
        gap: 4px;
      }

      .mode-btn {
        padding: 8px 4px;
        font-size: 10px;
        min-height: auto;
      }

      .mode-btn svg {
        width: 18px;
        height: 18px;
      }

      .action-btn {
        padding: 10px;
        font-size: 13px;
      }

      .playback-controls {
        padding: 8px 12px;
      }

      .control-btn {
        width: 36px;
        height: 36px;
      }

      .control-btn.play-btn {
        width: 42px;
        height: 42px;
      }
    }

    /* Touch device optimizations */
    @media (hover: none) and (pointer: coarse) {
      .mode-btn:active {
        background: var(--bg-tertiary);
      }

      .route-option:active {
        background: var(--bg-tertiary);
      }

      /* Disable hover states on touch */
      .control-btn:hover,
      .mode-btn:hover,
      .route-option:hover {
        background: inherit;
      }

      .control-btn.play-btn:hover {
        background: var(--accent);
      }

      .mode-btn.active:hover {
        background: var(--accent-glow);
      }
    }

    /* Safe area insets for notched phones */
    @supports (padding: env(safe-area-inset-bottom)) {
      .status-bar {
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
    }

    /* Google Places Autocomplete styling */
    .pac-container {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
      margin-top: 4px;
    }

    .pac-item {
      padding: 10px 14px;
      color: var(--text-primary);
      border-top: 1px solid var(--border);
      cursor: pointer;
    }

    .pac-item:first-child {
      border-top: none;
    }

    .pac-item:hover,
    .pac-item-selected {
      background: var(--bg-secondary);
    }

    .pac-item-query {
      color: var(--text-primary);
      font-weight: 500;
    }

    .pac-matched {
      color: var(--accent);
      font-weight: 600;
    }

    .pac-icon {
      display: none;
    }

    .pac-logo::after {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Password Gate -->
  <div class="password-gate" id="password-gate">
    <div class="password-modal">
      <div class="password-logo">
        <div class="password-logo-icon">
          <svg viewBox="300 50 600 700" fill="currentColor">
            <path d="M833.556,367.574c-7.753-7.955-18.586-12.155-29.656-11.549l-133.981,7.458l73.733-83.975c10.504-11.962,13.505-27.908,9.444-42.157c-2.143-9.764-8.056-18.648-17.14-24.324c-0.279-0.199-176.247-102.423-176.247-102.423c-14.369-8.347-32.475-6.508-44.875,4.552l-85.958,76.676c-15.837,14.126-17.224,38.416-3.097,54.254c14.128,15.836,38.419,17.227,54.255,3.096l65.168-58.131l53.874,31.285l-95.096,108.305c-39.433,6.431-74.913,24.602-102.765,50.801l49.66,49.66c22.449-20.412,52.256-32.871,84.918-32.871c69.667,0,126.346,56.68,126.346,126.348c0,32.662-12.459,62.467-32.869,84.916l49.657,49.66c33.08-35.166,53.382-82.484,53.382-134.576c0-31.035-7.205-60.384-20.016-86.482l51.861-2.889l-12.616,154.75c-1.725,21.152,14.027,39.695,35.18,41.422c1.059,0.086,2.116,0.127,3.163,0.127c19.806,0,36.621-15.219,38.257-35.306l16.193-198.685C845.235,386.445,841.305,375.527,833.556,367.574z"/>
            <path d="M762.384,202.965c35.523,0,64.317-28.797,64.317-64.322c0-35.523-28.794-64.323-64.317-64.323c-35.527,0-64.323,28.8-64.323,64.323C698.061,174.168,726.856,202.965,762.384,202.965z"/>
            <path d="M535.794,650.926c-69.668,0-126.348-56.68-126.348-126.348c0-26.256,8.056-50.66,21.817-70.887l-50.196-50.195c-26.155,33.377-41.791,75.393-41.791,121.082c0,108.535,87.983,196.517,196.518,196.517c45.691,0,87.703-15.636,121.079-41.792l-50.195-50.193C586.452,642.867,562.048,650.926,535.794,650.926z"/>
          </svg>
        </div>
        <span class="password-logo-text">Glide</span>
      </div>
      <p class="password-tagline">See your route before you go. Glide smoothly.</p>
      <div class="password-form">
        <input type="password" class="password-input" id="password-input" placeholder="Enter access code" autocomplete="off">
        <button class="password-btn" id="password-btn">Enter</button>
      </div>
      <p class="password-error" id="password-error"></p>
    </div>
  </div>

  <div class="app-container" id="app-container" style="display: none;">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <svg viewBox="300 50 600 700" fill="currentColor">
            <path d="M833.556,367.574c-7.753-7.955-18.586-12.155-29.656-11.549l-133.981,7.458l73.733-83.975c10.504-11.962,13.505-27.908,9.444-42.157c-2.143-9.764-8.056-18.648-17.14-24.324c-0.279-0.199-176.247-102.423-176.247-102.423c-14.369-8.347-32.475-6.508-44.875,4.552l-85.958,76.676c-15.837,14.126-17.224,38.416-3.097,54.254c14.128,15.836,38.419,17.227,54.255,3.096l65.168-58.131l53.874,31.285l-95.096,108.305c-39.433,6.431-74.913,24.602-102.765,50.801l49.66,49.66c22.449-20.412,52.256-32.871,84.918-32.871c69.667,0,126.346,56.68,126.346,126.348c0,32.662-12.459,62.467-32.869,84.916l49.657,49.66c33.08-35.166,53.382-82.484,53.382-134.576c0-31.035-7.205-60.384-20.016-86.482l51.861-2.889l-12.616,154.75c-1.725,21.152,14.027,39.695,35.18,41.422c1.059,0.086,2.116,0.127,3.163,0.127c19.806,0,36.621-15.219,38.257-35.306l16.193-198.685C845.235,386.445,841.305,375.527,833.556,367.574z"/>
            <path d="M762.384,202.965c35.523,0,64.317-28.797,64.317-64.322c0-35.523-28.794-64.323-64.317-64.323c-35.527,0-64.323,28.8-64.323,64.323C698.061,174.168,726.856,202.965,762.384,202.965z"/>
            <path d="M535.794,650.926c-69.668,0-126.348-56.68-126.348-126.348c0-26.256,8.056-50.66,21.817-70.887l-50.196-50.195c-26.155,33.377-41.791,75.393-41.791,121.082c0,108.535,87.983,196.517,196.518,196.517c45.691,0,87.703-15.636,121.079-41.792l-50.195-50.193C586.452,642.867,562.048,650.926,535.794,650.926z"/>
          </svg>
        </div>
        <span class="logo-text">Glide</span>
        <span class="logo-strapline">See your route before you go. Glide smoothly.</span>
      </div>
      <div class="header-right">
        <div class="steps-indicator">
          <div class="step-dot active" data-step="1"></div>
          <div class="step-line"></div>
          <div class="step-dot" data-step="2"></div>
          <div class="step-line"></div>
          <div class="step-dot" data-step="3"></div>
        </div>
        <button class="theme-toggle" id="theme-toggle" title="Toggle light/dark mode">
          <svg class="icon-sun" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
          </svg>
          <svg class="icon-moon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- Main content -->
    <main class="main-content">
      <!-- View area: contains map and street view (they share this space) -->
      <div class="view-area">
        <div class="map-container">
          <div id="map"></div>

          <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Loading...</div>
            <div class="loading-progress">
              <div class="loading-progress-fill" id="loading-progress-fill"></div>
            </div>
          </div>
        </div>

        <!-- Street view panel -->
      <div class="streetview-panel" id="streetview-panel">
        <div class="streetview-image-container">
          <img id="streetview-img-1" class="streetview-image" alt="Street view">
          <img id="streetview-img-2" class="streetview-image" alt="Street view">
          <div id="streetview-placeholder" class="streetview-placeholder">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <p>No imagery available</p>
          </div>
          
          <button class="back-btn" id="btn-back">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back to map
          </button>

          <div class="frame-counter" id="frame-counter">
            <span id="current-frame">0</span> / <span id="total-frames">0</span>
          </div>

          <div class="mini-map-container">
            <div id="mini-map"></div>
          </div>

          <div class="streetview-overlay" id="overlay">
            <div class="overlay-stats">
              <div class="stat">
                <span class="stat-label">Distance</span>
                <span class="stat-value" id="stat-distance">0m</span>
              </div>
              <div class="stat">
                <span class="stat-label">Progress</span>
                <span class="stat-value" id="stat-progress">0%</span>
              </div>
            </div>
          </div>
        </div>

        <button class="view-toggle-btn" id="btn-view-toggle" title="Toggle map view">
          <svg id="icon-map-view" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
          </svg>
          <svg id="icon-image-view" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </button>

        <!-- Playback controls -->
        <div class="playback-controls">
          <div class="progress-bar" id="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="controls-row">
            <div class="transport-controls">
              <button class="control-btn" id="btn-start" title="Go to start">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
              </button>
              <button class="control-btn" id="btn-prev" title="Previous">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button class="control-btn play-btn" id="btn-play" title="Play/Pause">
                <svg id="icon-play" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"></path>
                </svg>
                <svg id="icon-pause" fill="currentColor" viewBox="0 0 24 24" style="display: none;">
                  <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path>
                </svg>
              </button>
              <button class="control-btn" id="btn-next" title="Next">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
              <button class="control-btn skip-btn" id="btn-end" title="Go to end">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <div class="speed-control">
              <button class="control-btn" id="btn-speed-down" title="Slower">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
              </button>
              <span class="speed-value" id="speed-value">1.0Ã—</span>
              <button class="control-btn" id="btn-speed-up" title="Faster">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
              </button>
            </div>
            <button class="control-btn fullscreen-btn" id="btn-fullscreen" title="Toggle fullscreen">
              <svg id="icon-expand" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
              </svg>
              <svg id="icon-collapse" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9V4H4m0 0l5 5m6-5h5v5m0 0l-5-5m-6 16v-5H4m0 0l5-5m6 10h5v-5m0 0l-5 5"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <!-- End of view-area -->
      </div>

      <!-- Elevation profile (below map/streetview) -->
      <div class="elevation-profile" id="elevation-profile">
        <div class="elevation-header">
          <span class="elevation-title">Elevation Profile</span>
          <span class="elevation-stats" id="elevation-stats"></span>
        </div>
        <div class="elevation-canvas-container">
          <canvas id="elevation-canvas"></canvas>
          <div class="elevation-marker" id="elevation-marker"></div>
        </div>
        <div class="elevation-legend">
          <span class="legend-item"><span class="legend-color safe"></span>&lt;5% Easy</span>
          <span class="legend-item"><span class="legend-color moderate"></span>5-8% Moderate</span>
          <span class="legend-item"><span class="legend-color steep"></span>&gt;8% Steep</span>
        </div>
      </div>
    </main>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-handle" id="sidebar-handle">
        <div class="handle-bar"></div>
      </div>
      <div class="sidebar-content">
        <div class="sidebar-section">
          <h3 class="section-title">Plan your route</h3>
          
          <div class="route-inputs">
            <div class="input-group">
              <div class="input-icon origin"></div>
              <input type="text" class="route-input has-location-btn" id="input-origin" placeholder="Start address">
              <button type="button" class="location-btn" id="use-my-location" title="Use my location">
                <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
              </button>
            </div>
            <div class="input-group">
              <div class="input-icon destination"></div>
              <input type="text" class="route-input" id="input-destination" placeholder="Destination or postcode">
            </div>
          </div>

          <div class="mode-selector">
            <button class="mode-btn active" data-mode="WHEELCHAIR">
              <svg viewBox="300 50 600 700" fill="currentColor">
                <path d="M833.556,367.574c-7.753-7.955-18.586-12.155-29.656-11.549l-133.981,7.458l73.733-83.975c10.504-11.962,13.505-27.908,9.444-42.157c-2.143-9.764-8.056-18.648-17.14-24.324c-0.279-0.199-176.247-102.423-176.247-102.423c-14.369-8.347-32.475-6.508-44.875,4.552l-85.958,76.676c-15.837,14.126-17.224,38.416-3.097,54.254c14.128,15.836,38.419,17.227,54.255,3.096l65.168-58.131l53.874,31.285l-95.096,108.305c-39.433,6.431-74.913,24.602-102.765,50.801l49.66,49.66c22.449-20.412,52.256-32.871,84.918-32.871c69.667,0,126.346,56.68,126.346,126.348c0,32.662-12.459,62.467-32.869,84.916l49.657,49.66c33.08-35.166,53.382-82.484,53.382-134.576c0-31.035-7.205-60.384-20.016-86.482l51.861-2.889l-12.616,154.75c-1.725,21.152,14.027,39.695,35.18,41.422c1.059,0.086,2.116,0.127,3.163,0.127c19.806,0,36.621-15.219,38.257-35.306l16.193-198.685C845.235,386.445,841.305,375.527,833.556,367.574z"/>
                <path d="M762.384,202.965c35.523,0,64.317-28.797,64.317-64.322c0-35.523-28.794-64.323-64.317-64.323c-35.527,0-64.323,28.8-64.323,64.323C698.061,174.168,726.856,202.965,762.384,202.965z"/>
                <path d="M535.794,650.926c-69.668,0-126.348-56.68-126.348-126.348c0-26.256,8.056-50.66,21.817-70.887l-50.196-50.195c-26.155,33.377-41.791,75.393-41.791,121.082c0,108.535,87.983,196.517,196.518,196.517c45.691,0,87.703-15.636,121.079-41.792l-50.195-50.193C586.452,642.867,562.048,650.926,535.794,650.926z"/>
              </svg>
              Wheels
            </button>
            <button class="mode-btn" data-mode="WALKING">
              <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/>
              </svg>
              Walk
            </button>
            <button class="mode-btn" data-mode="BICYCLING">
              <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M15.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM5 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5zm5.8-10l2.4-2.4.8.8c1.3 1.3 3 2.1 5.1 2.1V9c-1.5 0-2.7-.6-3.6-1.5l-1.9-1.9c-.5-.4-1-.6-1.6-.6s-1.1.2-1.4.6L7.8 8.4c-.4.4-.6.9-.6 1.4 0 .6.2 1.1.6 1.4L11 14v5h2v-6.2l-2.2-2.3zM19 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/>
              </svg>
              Cycle
            </button>
            <button class="mode-btn" data-mode="DRIVING">
              <svg fill="currentColor" viewBox="0 0 24 24">
                <path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/>
              </svg>
              Drive
            </button>
          </div>

          <button class="action-btn primary" id="btn-find-routes">Find Routes</button>

          <!-- Recent Routes -->
          <div class="recent-routes" id="recent-routes" style="display: none;">
            <h4 class="recent-routes-title">Recent Routes</h4>
            <div class="recent-routes-list" id="recent-routes-list"></div>
          </div>
        </div>

        <!-- Route options (Step 2) -->
        <div class="sidebar-section" id="section-routes" style="display: none;">
          <h3 class="section-title">Choose a route</h3>
          <div class="route-options" id="route-options"></div>
          
          <div class="route-summary" id="route-summary">
            <div class="route-summary-grid">
              <div class="summary-item">
                <span class="summary-label">Distance</span>
                <span class="summary-value" id="summary-distance">â€”</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Duration</span>
                <span class="summary-value" id="summary-duration">â€”</span>
              </div>
            </div>
          </div>

          <div class="drag-hint" id="drag-hint">
            ðŸ’¡ Drag the route on the map to adjust it.
          </div>

          <div class="accessibility-notice" id="accessibility-notice" style="display: none;">
            â™¿ <strong>Accessibility check:</strong> Use the Street View preview to check for steps, steep gradients, kerbs, and surface conditions along your route.
          </div>

          <button class="action-btn primary" id="btn-generate-preview">Show Street View Preview</button>
          <button class="action-btn secondary" id="btn-continue-preview" style="display: none;">Continue Preview</button>
        </div>

        <!-- Coverage (Step 3) -->
        <div class="sidebar-section" id="section-coverage" style="display: none;">
          <h3 class="section-title">Street View Coverage</h3>
          <div class="coverage-indicator">
            <div class="coverage-bar">
              <div class="coverage-fill" id="coverage-fill"></div>
            </div>
            <span class="coverage-text" id="coverage-text">0%</span>
          </div>
        </div>
        
        <!-- Spacer for scroll padding -->
        <div style="height: 20px; flex-shrink: 0;"></div>
      </div>

      <!-- Status bar -->
      <div class="status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status-text">Enter origin and destination</span>
        <span class="version">v1.2.9</span>
      </div>
    </aside>
  </div>

  <script>
    // ============================================
    // Configuration
    // ============================================
    const CONFIG = {
      GOOGLE_API_KEY: 'AIzaSyBoyUlTxideOK6HEk11Q3OhEjb2jbqEXXQ',
      SAMPLE_INTERVAL: 25,
      MAX_SAMPLE_POINTS: 100,
      PLAYBACK_INTERVAL: 400
    };

    // ============================================
    // State
    // ============================================
    const state = {
      currentStep: 1,
      map: null,
      miniMap: null,
      directionsService: null,
      directionsRenderer: null,
      routes: [],
      selectedRouteIndex: 0,
      selectedMode: 'WHEELCHAIR',
      routePoints: [],
      images: [],
      currentIndex: -1,
      activeImageEl: 1,
      isPlaying: false,
      playbackSpeed: 1,
      playbackTimer: null,
      currentMarker: null,
      miniMapRoute: null,
      userLocation: null,
      elevationService: null,
      elevationData: null,
      originalDirections: null
    };

    // ============================================
    // DOM Elements
    // ============================================
    const el = {
      streetviewPanel: document.getElementById('streetview-panel'),
      streetviewImg1: document.getElementById('streetview-img-1'),
      streetviewImg2: document.getElementById('streetview-img-2'),
      streetviewPlaceholder: document.getElementById('streetview-placeholder'),
      currentFrame: document.getElementById('current-frame'),
      totalFrames: document.getElementById('total-frames'),
      progressFill: document.getElementById('progress-fill'),
      btnPlay: document.getElementById('btn-play'),
      iconPlay: document.getElementById('icon-play'),
      iconPause: document.getElementById('icon-pause'),
      btnSpeedDown: document.getElementById('btn-speed-down'),
      btnSpeedUp: document.getElementById('btn-speed-up'),
      speedValue: document.getElementById('speed-value'),
      inputOrigin: document.getElementById('input-origin'),
      btnUseMyLocation: document.getElementById('use-my-location'),
      inputDestination: document.getElementById('input-destination'),
      btnFindRoutes: document.getElementById('btn-find-routes'),
      btnGeneratePreview: document.getElementById('btn-generate-preview'),
      btnContinuePreview: document.getElementById('btn-continue-preview'),
      btnBack: document.getElementById('btn-back'),
      btnFullscreen: document.getElementById('btn-fullscreen'),
      btnViewToggle: document.getElementById('btn-view-toggle'),
      iconMapView: document.getElementById('icon-map-view'),
      iconImageView: document.getElementById('icon-image-view'),
      sectionRoutes: document.getElementById('section-routes'),
      sectionCoverage: document.getElementById('section-coverage'),
      routeOptions: document.getElementById('route-options'),
      routeSummary: document.getElementById('route-summary'),
      summaryDistance: document.getElementById('summary-distance'),
      summaryDuration: document.getElementById('summary-duration'),
      statusDot: document.getElementById('status-dot'),
      statusText: document.getElementById('status-text'),
      coverageFill: document.getElementById('coverage-fill'),
      coverageText: document.getElementById('coverage-text'),
      loadingOverlay: document.getElementById('loading-overlay'),
      loadingText: document.getElementById('loading-text'),
      loadingProgressFill: document.getElementById('loading-progress-fill'),
      statDistance: document.getElementById('stat-distance'),
      statProgress: document.getElementById('stat-progress'),
      progressBar: document.getElementById('progress-bar'),
      dragHint: document.getElementById('drag-hint'),
      accessibilityNotice: document.getElementById('accessibility-notice'),
      themeToggle: document.getElementById('theme-toggle'),
      recentRoutes: document.getElementById('recent-routes'),
      recentRoutesList: document.getElementById('recent-routes-list'),
      elevationProfile: document.getElementById('elevation-profile'),
      elevationCanvas: document.getElementById('elevation-canvas'),
      elevationStats: document.getElementById('elevation-stats'),
      elevationMarker: document.getElementById('elevation-marker')
    };

    // ============================================
    // Utilities
    // ============================================
    function setStatus(msg, type = '') {
      el.statusText.textContent = msg;
      el.statusDot.className = 'status-dot ' + type;
    }

    function showLoading(msg, progress = 0) {
      el.loadingOverlay.classList.add('visible');
      el.loadingText.textContent = msg;
      el.loadingProgressFill.style.width = progress + '%';
    }

    function hideLoading() {
      el.loadingOverlay.classList.remove('visible');
    }

    function updateStepIndicator(step) {
      document.querySelectorAll('.step-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i + 1 < step) dot.classList.add('completed');
        if (i + 1 === step) dot.classList.add('active');
      });
      document.querySelectorAll('.step-line').forEach((line, i) => {
        line.classList.toggle('completed', i + 1 < step);
      });
    }

    const darkMapStyles = [
      { elementType: 'geometry', stylers: [{ color: '#1c1c1f' }] },
      { elementType: 'labels.text.stroke', stylers: [{ color: '#1c1c1f' }] },
      { elementType: 'labels.text.fill', stylers: [{ color: '#636366' }] },
      { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2c2c30' }] },
      { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#8a8a8a' }] },
      { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e10' }] },
      { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }
    ];

    const lightMapStyles = [
      { elementType: 'geometry', stylers: [{ color: '#f5f5f7' }] },
      { elementType: 'labels.text.stroke', stylers: [{ color: '#ffffff' }] },
      { elementType: 'labels.text.fill', stylers: [{ color: '#6e6e73' }] },
      { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#ffffff' }] },
      { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#6e6e73' }] },
      { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#d2d2d7' }] },
      { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }
    ];

    function toggleTheme() {
      const isLight = document.body.classList.toggle('light-mode');
      localStorage.setItem('glide-theme', isLight ? 'light' : 'dark');
      updateThemeIcon(isLight);
      updateMapStyles(isLight);
    }

    function updateThemeIcon(isLight) {
      el.themeToggle.querySelector('.icon-sun').style.display = isLight ? 'none' : 'block';
      el.themeToggle.querySelector('.icon-moon').style.display = isLight ? 'block' : 'none';
    }

    function updateMapStyles(isLight) {
      if (state.map) {
        state.map.setOptions({ styles: isLight ? lightMapStyles : darkMapStyles });
      }
      if (state.miniMap) {
        state.miniMap.setOptions({ styles: isLight ? lightMapStyles : darkMapStyles });
      }
    }

    function loadSavedTheme() {
      const saved = localStorage.getItem('glide-theme');
      if (saved === 'light') {
        document.body.classList.add('light-mode');
        updateThemeIcon(true);
      }
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(Î”Ï†/2) ** 2 + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function calculateBearing(lat1, lon1, lat2, lon2) {
      const Ï†1 = lat1 * Math.PI / 180;
      const Ï†2 = lat2 * Math.PI / 180;
      const Î”Î» = (lon2 - lon1) * Math.PI / 180;
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
      return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }

    // ============================================
    // Recent Routes
    // ============================================
    const MAX_RECENT_ROUTES = 3;

    function saveRecentRoute(origin, destination, mode, images, distance, duration) {
      const routes = getRecentRoutes();

      const newRoute = {
        id: Date.now(),
        origin,
        destination,
        mode,
        images,
        distance,
        duration,
        coverage: images.filter(i => i.hasImage).length,
        totalImages: images.length,
        timestamp: new Date().toISOString()
      };

      // Remove duplicate routes (same origin/destination/mode)
      const filtered = routes.filter(r =>
        !(r.origin === origin && r.destination === destination && r.mode === mode)
      );

      // Add new route at the start, keep max 3
      filtered.unshift(newRoute);
      const trimmed = filtered.slice(0, MAX_RECENT_ROUTES);

      localStorage.setItem('glide-recent-routes', JSON.stringify(trimmed));
      displayRecentRoutes();
    }

    function getRecentRoutes() {
      try {
        return JSON.parse(localStorage.getItem('glide-recent-routes')) || [];
      } catch {
        return [];
      }
    }

    function displayRecentRoutes() {
      const routes = getRecentRoutes();

      if (routes.length === 0) {
        el.recentRoutes.style.display = 'none';
        return;
      }

      el.recentRoutes.style.display = 'block';
      el.recentRoutesList.innerHTML = routes.map(route => {
        const modeIcon = getModeIcon(route.mode);
        const timeAgo = getTimeAgo(route.timestamp);
        return `
          <div class="recent-route-item" data-route-id="${route.id}">
            <div class="recent-route-icon">${modeIcon}</div>
            <div class="recent-route-info">
              <div class="recent-route-name">${route.origin} â†’ ${route.destination}</div>
              <div class="recent-route-meta">${route.distance} Â· ${route.coverage}/${route.totalImages} images Â· ${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      el.recentRoutesList.querySelectorAll('.recent-route-item').forEach(item => {
        item.addEventListener('click', () => {
          const routeId = parseInt(item.dataset.routeId);
          loadRecentRoute(routeId);
        });
      });
    }

    function loadRecentRoute(routeId) {
      const routes = getRecentRoutes();
      const route = routes.find(r => r.id === routeId);

      if (!route) return;

      // Scroll page to top so map is fully visible
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Populate inputs
      el.inputOrigin.value = route.origin;
      el.inputDestination.value = route.destination;

      // Set the travel mode
      state.selectedMode = route.mode;
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === route.mode);
      });

      // Find routes to show map + elevation (like clicking Find Routes)
      // This also scrolls the sidebar to "Choose a Route" section
      findRoutes();
    }

    function getModeIcon(mode) {
      const icons = {
        'WHEELCHAIR': '<svg viewBox="300 50 600 700" fill="currentColor"><path d="M833.556,367.574c-7.753-7.955-18.586-12.155-29.656-11.549l-133.981,7.458l73.733-83.975c10.504-11.962,13.505-27.908,9.444-42.157c-2.143-9.764-8.056-18.648-17.14-24.324c-0.279-0.199-176.247-102.423-176.247-102.423c-14.369-8.347-32.475-6.508-44.875,4.552l-85.958,76.676c-15.837,14.126-17.224,38.416-3.097,54.254c14.128,15.836,38.419,17.227,54.255,3.096l65.168-58.131l53.874,31.285l-95.096,108.305c-39.433,6.431-74.913,24.602-102.765,50.801l49.66,49.66c22.449-20.412,52.256-32.871,84.918-32.871c69.667,0,126.346,56.68,126.346,126.348c0,32.662-12.459,62.467-32.869,84.916l49.657,49.66c33.08-35.166,53.382-82.484,53.382-134.576c0-31.035-7.205-60.384-20.016-86.482l51.861-2.889l-12.616,154.75c-1.725,21.152,14.027,39.695,35.18,41.422c1.059,0.086,2.116,0.127,3.163,0.127c19.806,0,36.621-15.219,38.257-35.306l16.193-198.685C845.235,386.445,841.305,375.527,833.556,367.574z"/><path d="M762.384,202.965c35.523,0,64.317-28.797,64.317-64.322c0-35.523-28.794-64.323-64.317-64.323c-35.527,0-64.323,28.8-64.323,64.323C698.061,174.168,726.856,202.965,762.384,202.965z"/><path d="M535.794,650.926c-69.668,0-126.348-56.68-126.348-126.348c0-26.256,8.056-50.66,21.817-70.887l-50.196-50.195c-26.155,33.377-41.791,75.393-41.791,121.082c0,108.535,87.983,196.517,196.518,196.517c45.691,0,87.703-15.636,121.079-41.792l-50.195-50.193C586.452,642.867,562.048,650.926,535.794,650.926z"/></svg>',
        'WALKING': '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"/></svg>',
        'BICYCLING': '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM5 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5zm5.8-10l2.4-2.4.8.8c1.3 1.3 3 2.1 5.1 2.1V9c-1.5 0-2.7-.6-3.6-1.5l-1.9-1.9c-.5-.4-1-.6-1.6-.6s-1.1.2-1.4.6L7.8 8.4c-.4.4-.6.9-.6 1.4 0 .6.2 1.1.6 1.4L11 14v5h2v-6.2l-2.2-2.3zM19 12c-2.8 0-5 2.2-5 5s2.2 5 5 5 5-2.2 5-5-2.2-5-5-5zm0 8.5c-1.9 0-3.5-1.6-3.5-3.5s1.6-3.5 3.5-3.5 3.5 1.6 3.5 3.5-1.6 3.5-3.5 3.5z"/></svg>',
        'DRIVING': '<svg fill="currentColor" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>'
      };
      return icons[mode] || icons['WALKING'];
    }

    function getTimeAgo(timestamp) {
      const now = new Date();
      const then = new Date(timestamp);
      const diff = Math.floor((now - then) / 1000);

      if (diff < 60) return 'Just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
      return then.toLocaleDateString();
    }

    // ============================================
    // Google Maps Init
    // ============================================
    const DEFAULT_LOCATION = { lat: 51.505, lng: -0.09 }; // London fallback

    function initMap() {
      const isLight = document.body.classList.contains('light-mode');
      state.map = new google.maps.Map(document.getElementById('map'), {
        center: DEFAULT_LOCATION,
        zoom: 13,
        styles: isLight ? lightMapStyles : darkMapStyles,
        disableDefaultUI: true,
        zoomControl: true,
        zoomControlOptions: { position: google.maps.ControlPosition.RIGHT_BOTTOM }
      });

      state.directionsService = new google.maps.DirectionsService();
      state.elevationService = new google.maps.ElevationService();
      state.directionsRenderer = new google.maps.DirectionsRenderer({
        map: state.map,
        draggable: true,
        polylineOptions: {
          strokeColor: '#22c55e',
          strokeWeight: 5
        },
        suppressMarkers: false
      });

      // Listen for route changes when user drags
      state.directionsRenderer.addListener('directions_changed', () => {
        const directions = state.directionsRenderer.getDirections();
        if (directions && directions.routes.length > 0) {
          // Update state.routes to keep in sync with dragged route
          state.routes = directions.routes;
          // Use valid index (dragged routes may only have 1 route at index 0)
          const routeIndex = Math.min(state.selectedRouteIndex, directions.routes.length - 1);
          updateRouteSummary(directions.routes[routeIndex]);
        }
      });

      // Setup Places Autocomplete with location bias
      const autocompleteOptions = {
        fields: ['formatted_address', 'geometry', 'name'],
        types: ['geocode', 'establishment']
      };

      state.originAutocomplete = new google.maps.places.Autocomplete(
        el.inputOrigin,
        autocompleteOptions
      );
      state.destinationAutocomplete = new google.maps.places.Autocomplete(
        el.inputDestination,
        autocompleteOptions
      );

      // Bias to 5km radius around map center (prioritizes nearby but still shows distant)
      function updateAutocompleteBias() {
        const center = state.map.getCenter();
        const circle = new google.maps.Circle({ center, radius: 5000 });
        const bounds = circle.getBounds();
        state.originAutocomplete.setBounds(bounds);
        state.destinationAutocomplete.setBounds(bounds);
      }

      updateAutocompleteBias();
      state.map.addListener('idle', updateAutocompleteBias);

      // When a place is selected, update the input value
      state.originAutocomplete.addListener('place_changed', () => {
        const place = state.originAutocomplete.getPlace();
        if (place.geometry) {
          el.inputOrigin.value = place.formatted_address || place.name;
        }
      });

      state.destinationAutocomplete.addListener('place_changed', () => {
        const place = state.destinationAutocomplete.getPlace();
        if (place.geometry) {
          el.inputDestination.value = place.formatted_address || place.name;
        }
      });

      // Try to get user's location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            state.map.setCenter(userLocation);
            el.inputOrigin.value = 'My Location';
            el.inputDestination.value = '';
            el.inputDestination.focus();
            state.userLocation = userLocation;
          },
          () => {
            // Geolocation denied or failed - set London defaults
            el.inputOrigin.value = 'SW1A 1AA';
            el.inputDestination.value = 'WC2N 5DU';
          },
          { timeout: 5000 }
        );
      } else {
        // No geolocation support - set London defaults
        el.inputOrigin.value = 'SW1A 1AA';
        el.inputDestination.value = 'WC2N 5DU';
      }
    }

    function initMiniMap() {
      state.miniMap = new google.maps.Map(document.getElementById('mini-map'), {
        center: DEFAULT_LOCATION,
        zoom: 15,
        styles: [
          { elementType: 'geometry', stylers: [{ color: '#1c1c1f' }] },
          { elementType: 'labels.text.stroke', stylers: [{ color: '#1c1c1f' }] },
          { elementType: 'labels.text.fill', stylers: [{ color: '#636366' }] },
          { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2c2c30' }] },
          { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e10' }] },
          { featureType: 'poi', stylers: [{ visibility: 'off' }] }
        ],
        disableDefaultUI: true
      });
    }

    // ============================================
    // Route Finding
    // ============================================
    
    async function findRoutes() {
      let origin = el.inputOrigin.value.trim();
      const dest = el.inputDestination.value.trim();

      if (!origin || !dest) {
        setStatus('Please enter origin and destination', 'error');
        return;
      }

      // Convert "My Location" to coordinates
      if (origin.toLowerCase() === 'my location' && state.userLocation) {
        origin = state.userLocation;
      }

      el.btnFindRoutes.disabled = true;
      el.btnContinuePreview.style.display = 'none';
      state.images = []; // Clear previous images
      state.currentIndex = -1; // Reset for fresh preview
      setStatus('Finding routes...', 'loading');

      try {
        // Map wheelchair to walking mode in Google
        const travelMode = state.selectedMode === 'WHEELCHAIR' 
          ? google.maps.TravelMode.WALKING 
          : google.maps.TravelMode[state.selectedMode];

        const request = {
          origin: origin,
          destination: dest,
          travelMode: travelMode,
          provideRouteAlternatives: true,
          unitSystem: google.maps.UnitSystem.METRIC
        };

        state.directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            state.routes = result.routes;
            state.originalDirections = result;
            state.selectedRouteIndex = 0;

            state.directionsRenderer.setDirections(result);
            state.directionsRenderer.setRouteIndex(0);

            renderRouteOptions(result.routes);
            updateRouteSummary(result.routes[0]);

            state.currentStep = 2;
            updateStepIndicator(2);
            el.sectionRoutes.style.display = 'block';
            el.dragHint.style.display = 'block';

            // Scroll sidebar to show route options (without scrolling the page)
            const sidebarContent = document.querySelector('.sidebar-content');
            if (sidebarContent) {
              const sectionTop = el.sectionRoutes.offsetTop - sidebarContent.offsetTop;
              sidebarContent.scrollTo({ top: sectionTop, behavior: 'smooth' });
            }

            // Show accessibility notice for wheelchair mode
            if (state.selectedMode === 'WHEELCHAIR') {
              el.accessibilityNotice.style.display = 'block';
              setStatus('Review the Street View preview for accessibility', 'ready');
            } else {
              el.accessibilityNotice.style.display = 'none';
              setStatus('Select a route or drag to adjust', 'ready');
            }
          } else {
            setStatus('Could not find route: ' + status, 'error');
          }
          el.btnFindRoutes.disabled = false;
        });
      } catch (error) {
        setStatus('Error: ' + error.message, 'error');
        el.btnFindRoutes.disabled = false;
      }
    }

    function renderRouteOptions(routes) {
      el.routeOptions.innerHTML = routes.map((route, i) => {
        const leg = route.legs[0];
        const isSelected = i === state.selectedRouteIndex;
        const badge = i === 0 ? '<span class="route-option-badge recommended">Recommended</span>' : '';
        const summary = route.summary || '';

        return `
          <div class="route-option ${isSelected ? 'selected' : ''}" data-index="${i}">
            <div class="route-option-header">
              <span class="route-option-name">Route ${i + 1}</span>
              ${badge}
            </div>
            <div class="route-option-stats">
              <span>${leg.distance.text}</span>
              <span>${leg.duration.text}</span>
            </div>
            ${summary ? `<div class="route-option-summary">via ${summary}</div>` : ''}
          </div>
        `;
      }).join('');

      el.routeOptions.querySelectorAll('.route-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const index = parseInt(opt.dataset.index);
          selectRoute(index);
        });
      });

      // Show elevation profile for selected route
      showElevationProfile(routes[state.selectedRouteIndex]);
    }

    function selectRoute(index) {
      state.selectedRouteIndex = index;

      // Reset to original directions (undoes any dragging)
      if (state.originalDirections) {
        state.directionsRenderer.setDirections(state.originalDirections);
        state.routes = state.originalDirections.routes;
      }
      state.directionsRenderer.setRouteIndex(index);

      document.querySelectorAll('.route-option').forEach((opt, i) => {
        opt.classList.toggle('selected', i === index);
      });

      updateRouteSummary(state.routes[index]);

      // Hide street view panel so user can see the map with selected route
      if (el.streetviewPanel.classList.contains('active')) {
        hideStreetViewPanel();
      }

      // On mobile, scroll to top so map is fully visible
      if (window.innerWidth <= 900) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Update elevation profile for new route
      showElevationProfile(state.routes[index]);
    }

    function updateRouteSummary(route) {
      const leg = route.legs[0];
      el.summaryDistance.textContent = leg.distance.text;
      el.summaryDuration.textContent = leg.duration.text;
    }

    // ============================================
    // Elevation Profile
    // ============================================
    async function fetchElevation(route) {
      const path = route.overview_path;

      // Sample up to 256 points (API limit)
      const maxSamples = 256;
      const step = Math.max(1, Math.floor(path.length / maxSamples));
      const sampledPath = [];
      for (let i = 0; i < path.length; i += step) {
        sampledPath.push(path[i]);
      }
      // Always include the last point
      if (sampledPath[sampledPath.length - 1] !== path[path.length - 1]) {
        sampledPath.push(path[path.length - 1]);
      }

      return new Promise((resolve, reject) => {
        state.elevationService.getElevationAlongPath({
          path: sampledPath,
          samples: sampledPath.length
        }, (results, status) => {
          if (status === 'OK' && results) {
            resolve(results);
          } else {
            reject(status);
          }
        });
      });
    }

    function drawElevationProfile(elevationData) {
      const canvas = el.elevationCanvas;
      const ctx = canvas.getContext('2d');

      // Get computed line color (canvas doesn't support CSS variables)
      const lineColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim() || '#ffffff';

      // Set canvas size for high DPI
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);

      const width = rect.width;
      const height = rect.height;

      // Debug: check if dimensions are valid
      if (width === 0 || height === 0) {
        console.warn('Elevation canvas has no dimensions:', width, height);
        return;
      }
      const padding = { top: 10, bottom: 4, left: 0, right: 0 };
      const chartWidth = width - padding.left - padding.right;
      const chartHeight = height - padding.top - padding.bottom;

      // Get elevation range
      const elevations = elevationData.map(d => d.elevation);
      const minElev = Math.min(...elevations);
      const maxElev = Math.max(...elevations);
      const elevRange = maxElev - minElev || 1;

      // Calculate gradients between points
      const gradients = [];
      let totalClimb = 0;
      let totalDescent = 0;

      for (let i = 1; i < elevationData.length; i++) {
        const elevDiff = elevationData[i].elevation - elevationData[i-1].elevation;
        const loc1 = elevationData[i-1].location;
        const loc2 = elevationData[i].location;
        const distance = google.maps.geometry.spherical.computeDistanceBetween(loc1, loc2);

        const gradientPercent = distance > 0 ? (elevDiff / distance) * 100 : 0;
        gradients.push(gradientPercent);

        if (elevDiff > 0) totalClimb += elevDiff;
        else totalDescent += Math.abs(elevDiff);
      }

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw filled area with gradient coloring
      for (let i = 0; i < elevationData.length - 1; i++) {
        const x1 = padding.left + (i / (elevationData.length - 1)) * chartWidth;
        const x2 = padding.left + ((i + 1) / (elevationData.length - 1)) * chartWidth;
        const y1 = padding.top + chartHeight - ((elevationData[i].elevation - minElev) / elevRange) * chartHeight;
        const y2 = padding.top + chartHeight - ((elevationData[i + 1].elevation - minElev) / elevRange) * chartHeight;

        // Color based on gradient
        const gradient = Math.abs(gradients[i]);
        let color;
        if (gradient < 5) {
          color = 'rgba(34, 197, 94, 0.6)'; // Green - easy
        } else if (gradient < 8) {
          color = 'rgba(245, 158, 11, 0.6)'; // Orange - moderate
        } else {
          color = 'rgba(239, 68, 68, 0.6)'; // Red - steep
        }

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.lineTo(x2, padding.top + chartHeight);
        ctx.lineTo(x1, padding.top + chartHeight);
        ctx.closePath();
        ctx.fillStyle = color;
        ctx.fill();
      }

      // Draw line on top
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top + chartHeight - ((elevationData[0].elevation - minElev) / elevRange) * chartHeight);
      for (let i = 1; i < elevationData.length; i++) {
        const x = padding.left + (i / (elevationData.length - 1)) * chartWidth;
        const y = padding.top + chartHeight - ((elevationData[i].elevation - minElev) / elevRange) * chartHeight;
        ctx.lineTo(x, y);
      }
      ctx.strokeStyle = lineColor;
      ctx.lineWidth = 1.5;
      ctx.stroke();

      // Update stats
      el.elevationStats.textContent = `â†‘${Math.round(totalClimb)}m â†“${Math.round(totalDescent)}m`;
    }

    async function showElevationProfile(route) {
      try {
        const elevationData = await fetchElevation(route);
        state.elevationData = elevationData;
        // Show element first so canvas has dimensions
        el.elevationProfile.classList.add('active');
        // Double requestAnimationFrame to ensure layout is fully computed
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const canvas = el.elevationCanvas;
            const rect = canvas.getBoundingClientRect();
            // If canvas still has no dimensions, retry after a short delay
            if (rect.width === 0 || rect.height === 0) {
              setTimeout(() => drawElevationProfile(elevationData), 100);
            } else {
              drawElevationProfile(elevationData);
            }
          });
        });
      } catch (error) {
        console.warn('Could not fetch elevation data:', error);
        el.elevationProfile.classList.remove('active');
      }
    }

    function hideElevationProfile() {
      el.elevationProfile.classList.remove('active');
      el.elevationMarker.classList.remove('active');
    }

    function updateElevationMarker(progress) {
      if (!state.elevationData || state.elevationData.length === 0) {
        el.elevationMarker.classList.remove('active');
        return;
      }

      const canvas = el.elevationCanvas;
      const rect = canvas.getBoundingClientRect();
      const padding = { top: 10, bottom: 4, left: 0, right: 0 };
      const chartWidth = rect.width - padding.left - padding.right;
      const chartHeight = rect.height - padding.top - padding.bottom;

      // Get elevation range
      const elevations = state.elevationData.map(d => d.elevation);
      const minElev = Math.min(...elevations);
      const maxElev = Math.max(...elevations);
      const elevRange = maxElev - minElev || 1;

      // Calculate fractional index along the elevation data
      const n = state.elevationData.length;
      const fractionalIndex = (progress / 100) * (n - 1);
      const i0 = Math.floor(fractionalIndex);
      const i1 = Math.min(i0 + 1, n - 1);
      const t = fractionalIndex - i0; // interpolation factor (0-1)

      // Interpolate elevation between the two nearest data points
      const elev0 = state.elevationData[i0].elevation;
      const elev1 = state.elevationData[i1].elevation;
      const elevation = elev0 + t * (elev1 - elev0);

      // Calculate X and Y positions (matching how chart is drawn)
      const x = padding.left + (fractionalIndex / (n - 1)) * chartWidth;
      const y = padding.top + chartHeight - ((elevation - minElev) / elevRange) * chartHeight;

      // Update marker position
      el.elevationMarker.style.left = x + 'px';
      el.elevationMarker.style.top = y + 'px';
      el.elevationMarker.classList.add('active');
    }

    // ============================================
    // Sample Route Points
    // ============================================
    function sampleRoutePoints(route) {
      const points = [];
      const path = route.overview_path;
      
      // Calculate total distance
      let totalDistance = 0;
      for (let i = 0; i < path.length - 1; i++) {
        totalDistance += haversineDistance(
          path[i].lat(), path[i].lng(),
          path[i + 1].lat(), path[i + 1].lng()
        );
      }

      // Calculate interval
      let interval = CONFIG.SAMPLE_INTERVAL;
      const estimatedPoints = totalDistance / interval;
      if (estimatedPoints > CONFIG.MAX_SAMPLE_POINTS) {
        interval = totalDistance / CONFIG.MAX_SAMPLE_POINTS;
      }

      // Sample along path
      let distanceTravelled = 0;
      let nextSampleAt = 0;

      for (let i = 0; i < path.length - 1; i++) {
        const lat1 = path[i].lat();
        const lng1 = path[i].lng();
        const lat2 = path[i + 1].lat();
        const lng2 = path[i + 1].lng();
        
        const segmentLength = haversineDistance(lat1, lng1, lat2, lng2);
        const bearing = calculateBearing(lat1, lng1, lat2, lng2);

        let segmentProgress = 0;

        while (distanceTravelled + segmentProgress <= distanceTravelled + segmentLength) {
          const distanceIntoSegment = nextSampleAt - distanceTravelled;
          
          if (distanceIntoSegment >= 0 && distanceIntoSegment <= segmentLength) {
            const fraction = distanceIntoSegment / segmentLength;
            const lat = lat1 + (lat2 - lat1) * fraction;
            const lng = lng1 + (lng2 - lng1) * fraction;

            points.push({
              lat,
              lng,
              heading: bearing,
              distance: nextSampleAt
            });

            nextSampleAt += interval;
          } else {
            break;
          }
          segmentProgress = distanceIntoSegment;
        }

        distanceTravelled += segmentLength;
      }

      // Add final point
      const lastPoint = path[path.length - 1];
      const prevPoint = path[path.length - 2];
      const finalHeading = calculateBearing(
        prevPoint.lat(), prevPoint.lng(),
        lastPoint.lat(), lastPoint.lng()
      );
      
      points.push({
        lat: lastPoint.lat(),
        lng: lastPoint.lng(),
        heading: finalHeading,
        distance: totalDistance
      });

      return { points, totalDistance };
    }

    // ============================================
    // Street View Imagery
    // ============================================
    async function fetchStreetViewImages(points) {
      const images = [];
      let successCount = 0;

      for (let i = 0; i < points.length; i++) {
        const point = points[i];
        const progress = Math.round((i / points.length) * 100);
        showLoading(`Checking coverage... ${i + 1}/${points.length}`, progress);

        // Calculate forward heading
        let heading = point.heading;
        for (let j = i + 1; j < Math.min(i + 5, points.length); j++) {
          const nextPoint = points[j];
          const dist = haversineDistance(point.lat, point.lng, nextPoint.lat, nextPoint.lng);
          if (dist > 5) {
            heading = calculateBearing(point.lat, point.lng, nextPoint.lat, nextPoint.lng);
            break;
          }
        }

        try {
          const metadataUrl = `https://maps.googleapis.com/maps/api/streetview/metadata?location=${point.lat},${point.lng}&key=${CONFIG.GOOGLE_API_KEY}`;
          const response = await fetch(metadataUrl);
          const metadata = await response.json();

          if (metadata.status === 'OK') {
            const imageUrl = `https://maps.googleapis.com/maps/api/streetview?size=1024x768&location=${point.lat},${point.lng}&heading=${Math.round(heading)}&pitch=-5&fov=100&key=${CONFIG.GOOGLE_API_KEY}`;
            
            images.push({
              ...point,
              heading,
              imageUrl,
              hasImage: true
            });
            successCount++;
          } else {
            images.push({ ...point, heading, imageUrl: null, hasImage: false });
          }
        } catch (e) {
          images.push({ ...point, heading, imageUrl: null, hasImage: false });
        }

        if (i % 10 === 0) {
          await new Promise(r => setTimeout(r, 20));
        }
      }

      const coverage = Math.round((successCount / points.length) * 100);
      el.coverageFill.style.width = coverage + '%';
      el.coverageText.textContent = coverage + '% coverage';

      return images;
    }

    // ============================================
    // Preview Display
    // ============================================
    function showStreetViewPanel() {
      el.streetviewPanel.classList.add('active');
      document.body.classList.add('streetview-active');
      // Don't hide elevation profile - CSS handles visibility based on body classes
      state.currentStep = 3;
      updateStepIndicator(3);
      el.sectionRoutes.style.display = 'none';
      el.sectionCoverage.style.display = 'block';

      // Reset image crossfade state
      state.activeImageEl = 1;
      el.streetviewImg1.classList.remove('active', 'previous');
      el.streetviewImg2.classList.remove('active', 'previous');
      el.streetviewImg1.src = '';
      el.streetviewImg2.src = '';

      if (!state.miniMap) {
        initMiniMap();
      }

      // Clear existing mini map route
      if (state.miniMapRoute) {
        state.miniMapRoute.setMap(null);
      }

      // Draw route on mini map
      const directions = state.directionsRenderer.getDirections();
      if (directions && directions.routes.length > 0 && state.miniMap) {
        const routeIndex = Math.min(state.selectedRouteIndex, directions.routes.length - 1);
        const route = directions.routes[routeIndex];
        state.miniMapRoute = new google.maps.Polyline({
          path: route.overview_path,
          strokeColor: '#22c55e',
          strokeWeight: 3,
          map: state.miniMap
        });

        const bounds = new google.maps.LatLngBounds();
        route.overview_path.forEach(p => bounds.extend(p));
        state.miniMap.fitBounds(bounds);
      }
    }

    function hideStreetViewPanel() {
      el.streetviewPanel.classList.remove('active');
      el.streetviewPanel.classList.remove('show-map');
      document.body.classList.remove('streetview-active');
      document.body.classList.remove('streetview-fullscreen');
      document.body.classList.remove('showing-map');
      updateFullscreenIcon(false);
      el.elevationMarker.classList.remove('active');
      state.currentStep = 2;
      updateStepIndicator(2);
      el.sectionRoutes.style.display = 'block';
      el.sectionCoverage.style.display = 'none';
      pause();

      // Reset view toggle icon
      el.iconMapView.style.display = 'block';
      el.iconImageView.style.display = 'none';

      // Show continue button if we have images loaded
      if (state.images.length > 0) {
        el.btnContinuePreview.style.display = 'block';
      }
    }

    function toggleFullscreen() {
      const isFullscreen = document.body.classList.toggle('streetview-fullscreen');
      updateFullscreenIcon(isFullscreen);
    }

    function updateFullscreenIcon(isFullscreen) {
      document.getElementById('icon-expand').style.display = isFullscreen ? 'none' : 'block';
      document.getElementById('icon-collapse').style.display = isFullscreen ? 'block' : 'none';
    }

    function toggleViewMode() {
      const showingMap = el.streetviewPanel.classList.toggle('show-map');
      document.body.classList.toggle('showing-map', showingMap);
      el.iconMapView.style.display = showingMap ? 'none' : 'block';
      el.iconImageView.style.display = showingMap ? 'block' : 'none';
    }

    function displayImage(index) {
      if (index < 0 || index >= state.images.length) return;
      if (index === state.currentIndex) return; // Skip if same position

      const img = state.images[index];
      state.currentIndex = index;

      const progress = (index / (state.images.length - 1)) * 100;
      el.progressFill.style.width = progress + '%';
      el.currentFrame.textContent = index + 1;
      el.statDistance.textContent = Math.round(img.distance) + 'm';
      el.statProgress.textContent = Math.round(progress) + '%';

      // Update elevation marker
      updateElevationMarker(progress);

      // Update mini map
      if (state.miniMap) {
        if (state.currentMarker) state.currentMarker.setMap(null);
        
        state.currentMarker = new google.maps.Marker({
          position: { lat: img.lat, lng: img.lng },
          map: state.miniMap,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 8,
            fillColor: '#22c55e',
            fillOpacity: 1,
            strokeColor: '#fff',
            strokeWeight: 2
          }
        });

        state.miniMap.panTo({ lat: img.lat, lng: img.lng });
      }

      // Update image with crossfade
      if (img.hasImage && img.imageUrl) {
        el.streetviewPlaceholder.style.display = 'none';

        // Get current and next image elements
        const currentEl = state.activeImageEl === 1 ? el.streetviewImg1 : el.streetviewImg2;
        const nextEl = state.activeImageEl === 1 ? el.streetviewImg2 : el.streetviewImg1;

        // Load new image into the inactive element
        nextEl.onload = () => {
          // Crossfade: activate the new image, deactivate the old
          currentEl.classList.remove('active');
          currentEl.classList.add('previous');
          nextEl.classList.remove('previous');
          nextEl.classList.add('active');

          // Toggle for next time
          state.activeImageEl = state.activeImageEl === 1 ? 2 : 1;
        };
        nextEl.src = img.imageUrl;
      } else {
        el.streetviewImg1.classList.remove('active');
        el.streetviewImg2.classList.remove('active');
        el.streetviewPlaceholder.style.display = 'flex';
      }
    }

    // ============================================
    // Playback
    // ============================================
    function play() {
      if (state.images.length === 0) return;
      state.isPlaying = true;
      el.iconPlay.style.display = 'none';
      el.iconPause.style.display = 'block';

      const interval = CONFIG.PLAYBACK_INTERVAL / state.playbackSpeed;
      state.playbackTimer = setInterval(() => {
        if (state.currentIndex < state.images.length - 1) {
          displayImage(state.currentIndex + 1);
        } else {
          pause();
        }
      }, interval);
    }

    function pause() {
      state.isPlaying = false;
      el.iconPlay.style.display = 'block';
      el.iconPause.style.display = 'none';
      if (state.playbackTimer) {
        clearInterval(state.playbackTimer);
        state.playbackTimer = null;
      }
    }

    function togglePlayPause() {
      if (state.isPlaying) pause();
      else play();
    }

    function adjustSpeed(delta) {
      const newSpeed = Math.max(0.25, Math.min(4, state.playbackSpeed + delta));
      if (newSpeed !== state.playbackSpeed) {
        state.playbackSpeed = newSpeed;
        el.speedValue.textContent = state.playbackSpeed.toFixed(2).replace(/\.?0+$/, '') + 'Ã—';
        localStorage.setItem('glide-speed', state.playbackSpeed);
        if (state.isPlaying) { pause(); play(); }
      }
    }

    function loadSavedSpeed() {
      const saved = localStorage.getItem('glide-speed');
      if (saved) {
        state.playbackSpeed = parseFloat(saved);
        el.speedValue.textContent = state.playbackSpeed.toFixed(2).replace(/\.?0+$/, '') + 'Ã—';
      }
    }

    // ============================================
    // Generate Preview
    // ============================================
    async function generatePreview() {
      const directions = state.directionsRenderer.getDirections();
      if (!directions) {
        setStatus('Please select a route first', 'error');
        return;
      }

      el.btnGeneratePreview.disabled = true;
      el.btnContinuePreview.style.display = 'none';
      showLoading('Preparing route...', 0);

      try {
        // Use valid index (dragged routes may only have 1 route at index 0)
        const routeIndex = Math.min(state.selectedRouteIndex, directions.routes.length - 1);
        const route = directions.routes[routeIndex];
        const { points, totalDistance } = sampleRoutePoints(route);
        
        state.routePoints = points;
        state.images = await fetchStreetViewImages(points);
        
        el.totalFrames.textContent = state.images.length;
        
        showStreetViewPanel();
        displayImage(0);
        hideLoading();

        const coverage = state.images.filter(i => i.hasImage).length;
        setStatus(`${coverage}/${state.images.length} images loaded`, 'ready');

        // Save to recent routes
        const leg = route.legs[0];
        saveRecentRoute(
          el.inputOrigin.value,
          el.inputDestination.value,
          state.selectedMode,
          state.images,
          leg.distance.text,
          leg.duration.text
        );
      } catch (error) {
        hideLoading();
        setStatus('Error: ' + error.message, 'error');
      } finally {
        el.btnGeneratePreview.disabled = false;
      }
    }

    // ============================================
    // Event Listeners
    // ============================================
    function setupEventListeners() {
      el.btnFindRoutes.addEventListener('click', findRoutes);
      el.btnGeneratePreview.addEventListener('click', generatePreview);
      el.btnContinuePreview.addEventListener('click', () => {
        showStreetViewPanel();
        displayImage(state.currentIndex);
      });
      el.btnBack.addEventListener('click', hideStreetViewPanel);
      el.btnFullscreen.addEventListener('click', toggleFullscreen);
      el.btnViewToggle.addEventListener('click', toggleViewMode);
      el.themeToggle.addEventListener('click', toggleTheme);

      // Use my location button
      el.btnUseMyLocation.addEventListener('click', () => {
        el.inputOrigin.value = 'My Location';
        el.inputOrigin.focus();
      });

      // Mode selector
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          state.selectedMode = btn.dataset.mode;
        });
      });

      // Playback
      el.btnPlay.addEventListener('click', togglePlayPause);
      document.getElementById('btn-prev').addEventListener('click', () => {
        pause();
        if (state.currentIndex > 0) displayImage(state.currentIndex - 1);
      });
      document.getElementById('btn-next').addEventListener('click', () => {
        pause();
        if (state.currentIndex < state.images.length - 1) displayImage(state.currentIndex + 1);
      });
      document.getElementById('btn-start').addEventListener('click', () => {
        pause();
        displayImage(0);
      });
      document.getElementById('btn-end').addEventListener('click', () => {
        pause();
        displayImage(state.images.length - 1);
      });

      // Progress bar click
      el.progressBar.addEventListener('click', (e) => {
        if (state.images.length === 0) return;
        pause();
        const rect = el.progressBar.getBoundingClientRect();
        const fraction = (e.clientX - rect.left) / rect.width;
        displayImage(Math.round(fraction * (state.images.length - 1)));
      });

      // Elevation profile scrubbing (click and drag)
      let isScrubbing = false;

      function scrubToPosition(clientX) {
        if (state.images.length === 0) return;
        const rect = el.elevationCanvas.getBoundingClientRect();
        const fraction = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
        displayImage(Math.round(fraction * (state.images.length - 1)));
      }

      el.elevationCanvas.addEventListener('mousedown', (e) => {
        if (state.images.length === 0) return;
        isScrubbing = true;
        pause();
        scrubToPosition(e.clientX);
      });

      document.addEventListener('mousemove', (e) => {
        if (!isScrubbing) return;
        scrubToPosition(e.clientX);
      });

      document.addEventListener('mouseup', () => {
        isScrubbing = false;
      });

      // Touch support
      el.elevationCanvas.addEventListener('touchstart', (e) => {
        if (state.images.length === 0) return;
        isScrubbing = true;
        pause();
        scrubToPosition(e.touches[0].clientX);
      }, { passive: true });

      el.elevationCanvas.addEventListener('touchmove', (e) => {
        if (!isScrubbing) return;
        scrubToPosition(e.touches[0].clientX);
      }, { passive: true });

      el.elevationCanvas.addEventListener('touchend', () => {
        isScrubbing = false;
      });

      // Speed
      // Speed controls
      el.btnSpeedDown.addEventListener('click', () => adjustSpeed(-0.25));
      el.btnSpeedUp.addEventListener('click', () => adjustSpeed(0.25));

      // Keyboard
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        if (state.currentStep !== 3) return;
        
        switch (e.key) {
          case ' ': e.preventDefault(); togglePlayPause(); break;
          case 'ArrowLeft': pause(); if (state.currentIndex > 0) displayImage(state.currentIndex - 1); break;
          case 'ArrowRight': pause(); if (state.currentIndex < state.images.length - 1) displayImage(state.currentIndex + 1); break;
          case 'Escape':
            if (document.body.classList.contains('streetview-fullscreen')) {
              toggleFullscreen();
            } else {
              hideStreetViewPanel();
            }
            break;
          case 'f': toggleFullscreen(); break;
        }
      });

      // Enter in inputs
      el.inputOrigin.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') el.inputDestination.focus();
      });
      el.inputDestination.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') findRoutes();
      });

      // Mobile sidebar toggle
      const sidebarHandle = document.getElementById('sidebar-handle');
      const sidebar = document.querySelector('.sidebar');
      
      if (sidebarHandle) {
        sidebarHandle.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
        });

        // Touch drag to expand/collapse
        let startY = 0;
        let startHeight = 0;

        sidebarHandle.addEventListener('touchstart', (e) => {
          startY = e.touches[0].clientY;
          startHeight = sidebar.offsetHeight;
          sidebar.style.transition = 'none';
        }, { passive: true });

        sidebarHandle.addEventListener('touchmove', (e) => {
          const deltaY = startY - e.touches[0].clientY;
          const newHeight = Math.max(60, Math.min(window.innerHeight * 0.7, startHeight + deltaY));
          sidebar.style.maxHeight = newHeight + 'px';
        }, { passive: true });

        sidebarHandle.addEventListener('touchend', () => {
          sidebar.style.transition = '';
          const currentHeight = sidebar.offsetHeight;
          const threshold = window.innerHeight * 0.25;

          if (currentHeight < threshold) {
            sidebar.classList.add('collapsed');
            sidebar.style.maxHeight = '';
          } else {
            sidebar.classList.remove('collapsed');
            sidebar.style.maxHeight = '';
          }
        });
      }

      // Redraw elevation profile on resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (state.elevationData && el.elevationProfile.classList.contains('active')) {
            drawElevationProfile(state.elevationData);
          }
        }, 150);
      });
    }

    // Config
    const _0xf = 'ed01adcfa850504b63abeff7dd7e84458385bb57652488987132aa2f19651a95';
    const _0xs = 'gls_s';
    let _ml = false;

    async function _h(s) {
      const e = new TextEncoder().encode(s);
      const h = await crypto.subtle.digest('SHA-256', e);
      return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function _ck() {
      return localStorage.getItem(_0xs) === '1';
    }

    async function _vf(t) {
      if (await _h(t) === _0xf) {
        localStorage.setItem(_0xs, '1');
        return true;
      }
      return false;
    }

    function _sa() {
      document.getElementById('password-gate').classList.add('hidden');
      document.getElementById('app-container').style.display = 'grid';
    }

    function _spg() {
      const inp = document.getElementById('password-input');
      const btn = document.getElementById('password-btn');
      const err = document.getElementById('password-error');

      async function _try() {
        const t = inp.value.trim();
        if (await _vf(t)) {
          _sa();
          if (_ml) init();
        } else {
          err.textContent = 'Incorrect access code';
          inp.value = '';
          inp.focus();
        }
      }

      btn.addEventListener('click', _try);
      inp.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') _try();
      });

      inp.focus();
    }

    // ============================================
    // Init
    // ============================================
    function init() {
      loadSavedTheme();
      loadSavedSpeed();
      initMap();
      setupEventListeners();
      displayRecentRoutes();
      setStatus('Enter origin and destination', '');
    }

    // Called when Google Maps loads
    window.initApp = function() {
      _ml = true;
      if (_ck()) {
        _sa();
        init();
      }
    };

    // Check auth on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedTheme();
      if (!_ck()) {
        _spg();
      }
    });
  </script>
  
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBoyUlTxideOK6HEk11Q3OhEjb2jbqEXXQ&libraries=places&callback=initApp"></script>
</body>
</html>
